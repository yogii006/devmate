<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DevMate Chat</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body {
    font-family: Inter, Arial, sans-serif;
    margin: 0;
    background: #f7fafc;
    width: 97%;
    height: 100vh;
}
.container {
    width: 100%;
    height: 90vh;
    margin: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
}
h1 { margin: 0 0 10px 0; }

.nav {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 10px;
}
.nav a { color: #0366d6; text-decoration: none; }

.chat-container {
    flex: 1;
    border: 1px solid #ddd;
    padding: 12px;
    border-radius: 8px;
    background: #ffffff;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}
.message { 
    padding: 12px; 
    border-radius: 6px; 
    margin: 6px 0; 
    max-width: 70%; 
    line-height: 1.6;
}
.user { background: #0366d6; color: #fff; margin-left: auto; }
.ai { background: #eef2ff; color: #111; margin-right: auto; white-space: pre-wrap; }

.input-row {
    display: flex;
    gap: 8px;
    margin-top: 10px;
}
input[type=text] {
    flex: 1;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ddd;
}
button {
    padding: 10px 14px;
    border-radius: 6px;
    border: none;
    background: #0366d6;
    color: #fff;
    cursor: pointer;
}
button:hover { background-color: #0256a3; }

.download-btn {
    margin-top: 8px;
    padding: 8px 16px;
    background: #007bff;
    border-radius: 6px;
    color: white;
    border: none;
    cursor: pointer;
    font-size: 14px;
    display: block;
}
.download-btn:hover { background: #0056b3; }
</style>
</head>

<body>
<div class="container">
<h1>DevMate</h1>

<div class="nav">
<a href="index.html">Home</a>
<span id="usernameDisplay" style="margin-left:auto;font-weight:bold;"></span>
<button id="logoutBtn" onclick="logout()">Logout</button>
</div>

<div class="chat-container" id="chat"></div>

<div class="input-row">
<input type="text" id="userInput" placeholder="Type your message..." onkeypress="handleKeyPress(event)" />
<button onclick="sendMessage()">Send</button>
</div>
</div>

<script>
const apiRoot = "http://127.0.0.1:8000";
let token = localStorage.getItem("dev_token");
let currentUser = localStorage.getItem("dev_user");
let messages = [];

if (!token) window.location.href = "auth.html";
document.getElementById("usernameDisplay").textContent = currentUser;

function logout(){
    localStorage.removeItem("dev_token");
    localStorage.removeItem("dev_user");
    window.location.href = "auth.html";
}

function handleKeyPress(event) {
    if (event.key === "Enter") {
        event.preventDefault();
        sendMessage();
    }
}

function formatMessage(text) {
    // Convert numbered lists (e.g., "1. Item" or "1. **Item:**")
    text = text.replace(/(\d+)\.\s+(\*\*[^*]+\*\*:?)/g, '\n$1. $2');
    
    // Ensure proper spacing around numbered points
    text = text.replace(/(\d+\.\s+[^\n]+)/g, '\n$1');
    
    // Convert **bold** to regular text (or you could wrap in <strong> tags)
    text = text.replace(/\*\*([^*]+)\*\*/g, '$1');
    
    // Clean up multiple newlines
    text = text.replace(/\n{3,}/g, '\n\n');
    
    return text.trim();
}

function appendMessage(text, sender){
    const chat = document.getElementById("chat");
    const msgDiv = document.createElement("div");
    msgDiv.classList.add("message", sender);

    // Check for download links
    const linkMatch = text.match(/(https?:\/\/[^\s)]+\.supabase\.co[^\s)]+)/i);
    
    if(linkMatch){
        const url = linkMatch[1];
        const filename = url.split("/").pop().split("?")[0];
        
        // Remove URL from text and format
        let cleanText = text.replace(/\[Download[^\]]*\]\([^)]+\)/g, '').replace(url, '').trim();
        
        if (sender === 'ai') {
            cleanText = formatMessage(cleanText);
        }
        
        msgDiv.textContent = cleanText;

        const btn = document.createElement("button");
        btn.className = "download-btn";
        btn.textContent = `ðŸ“¥ Download ${filename}`;
        btn.onclick = async () => {
            btn.disabled = true;
            btn.textContent = "Downloading...";
            try {
                const r = await fetch(url);
                if (!r.ok) throw new Error("Download failed");
                const blob = await r.blob();
                const fileUrl = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = fileUrl;
                link.download = filename;
                link.click();
                URL.revokeObjectURL(fileUrl);
                btn.textContent = `ðŸ“¥ Download ${filename}`;
            } catch (err) {
                console.error(err);
                alert("Error downloading file");
                btn.textContent = `ðŸ“¥ Download ${filename}`;
            }
            btn.disabled = false;
        };
        msgDiv.appendChild(btn);
    } else {
        // Format AI messages with proper line breaks
        let formattedText = sender === 'ai' ? formatMessage(text) : text;
        msgDiv.textContent = formattedText;
    }

    chat.appendChild(msgDiv);
    chat.scrollTop = chat.scrollHeight;
}

async function sendMessage(){
    const input = document.getElementById("userInput");
    const val = input.value.trim();
    if(!val) return;

    appendMessage(val,"user");
    messages.push({role:"user",content:val});
    input.value="";

    try {
        const res = await fetch(`${apiRoot}/run`,{
            method:"POST",
            headers:{
                "Content-Type":"application/json",
                "Authorization":`Bearer ${token}`
            },
            body:JSON.stringify({messages})
        });

        const data = await res.json();
        const ai = data.messages?.slice(-1)[0]?.content || "No response from AI";
        appendMessage(ai,"ai");
        messages.push({role:"assistant",content:ai});
    } catch (err) {
        console.error(err);
        appendMessage("Error connecting to server", "ai");
    }
}
</script>
</body>
</html>